pluginManagement {
    // Determine Flutter SDK path here (must be inside pluginManagement or use environment)
    def flutterSdkPath = settings.hasProperty('flutter.sdk') ? settings.getProperty('flutter.sdk') : System.getenv('FLUTTER_ROOT')

    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
        if (flutterSdkPath != null) {
            maven {
                url "${flutterSdkPath}/packages/flutter_tools/gradle"
            }
        }
    }

    plugins {
        id 'com.android.application' version '8.1.3'
        id 'com.android.library' version '8.1.3'
        id 'org.jetbrains.kotlin.android' version '1.9.20'
    }
}

// Expose flutterSdkPath for later use in dependencyResolutionManagement
def flutterSdkPath = settings.hasProperty('flutter.sdk') ? settings.getProperty('flutter.sdk') : System.getenv('FLUTTER_ROOT')

dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.PREFER_SETTINGS)
    repositories {
        google()
        mavenCentral()
        // Hosted Flutter Maven repo (download.flutter.io) - required to resolve io.flutter artifacts
        maven {
            url "https://storage.googleapis.com/download.flutter.io"
        }
        if (flutterSdkPath != null) {
            // Local Flutter engine artifacts (contains io.flutter:... AARs)
            maven {
                url "${flutterSdkPath}/bin/cache/artifacts/engine/android"
            }
            // Also include the Flutter gradle plugin repo
            maven {
                url "${flutterSdkPath}/packages/flutter_tools/gradle/"
            }
        }
    }
}

rootProject.name = 'android'
include ':app'

// This allows for "plugins" to work below
// Plugin section moved here as per Flutter's requirements
def flutterProjectRoot = rootProject.projectDir.parentFile.toPath()
def plugins = new Properties()
def pluginsFile = new File(flutterProjectRoot.toFile(), '.flutter-plugins')
if (pluginsFile.exists()) {
    pluginsFile.withReader('UTF-8') { reader -> plugins.load(reader) }
}

plugins.each { name, path ->
    def pluginDirectory = flutterProjectRoot.resolve(path).resolve('android').toFile()
    include ":$name"
    project(":$name").projectDir = pluginDirectory
}
